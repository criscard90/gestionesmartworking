<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartPlanner Pro</title>
    
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2370/2370264.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
        }
        .sticky-header { backdrop-filter: blur(12px); background-color: rgba(37, 99, 235, 0.95); }
        
        select[data-type="presenza"] { color: #1e40af; background-color: #eff6ff; border: 1px solid #dbeafe; }
        select[data-type="sw"] { color: #166534; background-color: #f0fdf4; border: 1px solid #dcfce7; }
        select[data-type="ferie"] { color: #92400e; background-color: #fffbeb; border: 1px solid #fef3c7; }
        select[data-type="malattia"] { color: #991b1b; background-color: #fef2f2; border: 1px solid #fee2e2; }
        
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2rem !important;
            appearance: none;
        }
    </style>
</head>
<body class="pb-12">

    <header class="sticky top-0 z-50 sticky-header text-white p-4 shadow-sm">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black tracking-tight flex items-center gap-2">
                <i data-lucide="calendar-range" class="w-6 h-6"></i> PLANNER
            </h1>
            <select id="monthSelector" class="bg-blue-700 border border-blue-400 rounded-xl px-3 py-1.5 text-sm font-bold outline-none"></select>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 mt-6 space-y-4">
        
        <section class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <label class="block text-[10px] text-slate-400 mb-2 uppercase font-black tracking-widest">Smart %</label>
                    <input type="number" id="swPercentage" min="0" max="100" 
                        class="w-full bg-slate-50 rounded-2xl py-4 text-center text-2xl font-black text-slate-800 outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <div class="text-center">
                    <label class="block text-[10px] text-slate-400 mb-2 uppercase font-black tracking-widest">Recupero (gg)</label>
                    <input type="number" id="recoveryDays" min="0" 
                        class="w-full bg-slate-50 rounded-2xl py-4 text-center text-2xl font-black text-slate-800 outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
            </div>
        </section>

        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-800 rounded-2xl py-4 px-2 text-center shadow-sm">
                <span class="block text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-1">GG Lavorativi</span>
                <span id="ggLavorativi" class="text-white text-2xl font-black">-</span>
            </div>
            <div class="bg-indigo-700 rounded-2xl py-4 px-2 text-center shadow-sm">
                <span class="block text-[9px] text-indigo-200 font-bold uppercase tracking-widest mb-1">GG Netti (Base)</span>
                <span id="ggNetti" class="text-white text-2xl font-black">-</span>
            </div>
        </div>

        <section class="grid grid-cols-2 gap-3 sticky top-[75px] z-40">
            <div id="cardSW" class="bg-white rounded-[1.5rem] p-4 shadow-lg border-2 border-transparent transition-all">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span class="text-slate-500 text-[10px] font-bold uppercase">Smart Target</span>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="actualSW" class="text-3xl font-black text-slate-800">0</span>
                    <span class="text-slate-400 font-bold text-sm">/ <span id="targetSW">0</span></span>
                </div>
            </div>
            <div id="cardPresenza" class="bg-white rounded-[1.5rem] p-4 shadow-lg border-2 border-transparent transition-all">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-blue-600"></div>
                    <span class="text-slate-500 text-[10px] font-bold uppercase">Ufficio Target</span>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="actualPresenza" class="text-3xl font-black text-slate-800">0</span>
                    <span class="text-slate-400 font-bold text-sm">/ <span id="targetPresenza">0</span></span>
                </div>
            </div>
        </section>

        <div id="calendarList" class="space-y-2"></div>

    </main>

    <script>
        function getItalianHolidays(year) {
            const h = [`${year}-01-01`, `${year}-01-06`, `${year}-04-25`, `${year}-05-01`, `${year}-06-02`, `${year}-08-15`, `${year}-11-01`, `${year}-12-08`, `${year}-12-25`, `${year}-12-26` ];
            const a = year % 19, b = Math.floor(year / 100), c = year % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h_b = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h_b - k) % 7, m = Math.floor((a + 11 * h_b + 22 * l) / 451), month = Math.floor((h_b + l - 7 * m + 114) / 31), day = ((h_b + l - 7 * m + 114) % 31) + 1;
            const p = new Date(year, month - 1, day + 1);
            h.push(`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,'0')}-${String(p.getDate()).padStart(2,'0')}`);
            return h;
        }

        const state = {
            currentMonth: (() => { const now = new Date(); return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; })(),
            data: JSON.parse(localStorage.getItem('sw_db_v9')) || {},
            config: JSON.parse(localStorage.getItem('sw_config')) || { percentage: 60, recovery: 0 }
        };

        const dom = {
            monthSelector: document.getElementById('monthSelector'),
            swPercentage: document.getElementById('swPercentage'),
            recoveryDays: document.getElementById('recoveryDays'),
            calendarList: document.getElementById('calendarList'),
            targetSW: document.getElementById('targetSW'),
            targetPresenza: document.getElementById('targetPresenza'),
            actualSW: document.getElementById('actualSW'),
            actualPresenza: document.getElementById('actualPresenza'),
            ggLavorativi: document.getElementById('ggLavorativi'),
            ggNetti: document.getElementById('ggNetti'),
            cardSW: document.getElementById('cardSW'),
            cardPresenza: document.getElementById('cardPresenza')
        };

        function init() {
            // Carica configurazione salvata nei campi input
            dom.swPercentage.value = state.config.percentage;
            dom.recoveryDays.value = state.config.recovery;

            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                dom.monthSelector.innerHTML += `<option value="${val}" ${val === state.currentMonth ? 'selected' : ''}>
                    ${d.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}
                </option>`;
            }

            dom.monthSelector.addEventListener('change', e => { state.currentMonth = e.target.value; render(); });
            
            // Listener per salvare la configurazione appena cambia
            const saveConfig = () => {
                state.config.percentage = parseInt(dom.swPercentage.value) || 0;
                state.config.recovery = parseInt(dom.recoveryDays.value) || 0;
                localStorage.setItem('sw_config', JSON.stringify(state.config));
                render();
            };

            dom.swPercentage.addEventListener('input', saveConfig);
            dom.recoveryDays.addEventListener('input', saveConfig);
            
            render();
            lucide.createIcons();
        }

        function render() {
            const [year, month] = state.currentMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const holidays = getItalianHolidays(year);
            const monthKey = state.currentMonth;

            if (!state.data[monthKey]) state.data[monthKey] = {};

            let html = '';
            let totalWorkdays = 0;
            let count = { presenza: 0, sw: 0, ferie: 0, malattia: 0 };

            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month - 1, d, 12, 0, 0);
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                const isHoliday = holidays.includes(dateStr);

                if (!isWeekend && !isHoliday) {
                    totalWorkdays++;
                    const saved = state.data[monthKey][d] || 'presenza';
                    count[saved]++;
                    html += `
                        <div class="bg-white p-4 rounded-2xl flex items-center justify-between border border-slate-100 shadow-sm">
                            <div class="bg-slate-50 rounded-xl p-2 min-w-[55px] text-center">
                                <span class="block text-[10px] font-bold text-blue-600 uppercase tracking-tighter">${dateObj.toLocaleDateString('it-IT', { weekday: 'short' })}</span>
                                <span class="text-xl font-black text-slate-800">${d}</span>
                            </div>
                            <select onchange="updateDay(${d}, this.value)" data-type="${saved}" class="rounded-xl px-4 py-3 text-sm font-black transition-all outline-none">
                                <option value="presenza" ${saved === 'presenza' ? 'selected' : ''}>üè¢ Ufficio</option>
                                <option value="sw" ${saved === 'sw' ? 'selected' : ''}>üè† Smart</option>
                                <option value="ferie" ${saved === 'ferie' ? 'selected' : ''}>üå¥ Ferie</option>
                                <option value="malattia" ${saved === 'malattia' ? 'selected' : ''}>ü§í Malattia</option>
                            </select>
                        </div>`;
                }
            }
            dom.calendarList.innerHTML = html;

            const ggNetti = totalWorkdays - count.ferie;
            const targetSW = Math.max(0, Math.round(ggNetti * (state.config.percentage / 100)) - count.malattia);
            const targetPresenza = Math.round(ggNetti * (1 - state.config.percentage / 100)) + state.config.recovery;

            dom.ggLavorativi.textContent = totalWorkdays;
            dom.ggNetti.textContent = ggNetti;
            dom.targetSW.textContent = targetSW;
            dom.targetPresenza.textContent = targetPresenza;
            dom.actualSW.textContent = count.sw;
            dom.actualPresenza.textContent = count.presenza;

            dom.cardSW.style.borderColor = count.sw > targetSW ? '#ef4444' : 'transparent';
            dom.cardPresenza.style.borderColor = count.presenza < targetPresenza ? '#f59e0b' : 'transparent';

            localStorage.setItem('sw_db_v9', JSON.stringify(state.data));
            lucide.createIcons();
        }

        function updateDay(day, value) { state.data[state.currentMonth][day] = value; render(); }
        init();
    </script>
</body>
</html>
