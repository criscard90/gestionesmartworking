<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartPlanner Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .sticky-header { backdrop-filter: blur(12px); background-color: rgba(37, 99, 235, 0.95); }
        .hidden { display: none !important; }
        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1rem; padding-right: 2rem !important; }
    </style>
</head>
<body class="pb-10">

    <div id="authOverlay" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-6 text-center">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-sm w-full">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto mb-6 flex items-center justify-center text-white shadow-lg">
                <i data-lucide="map-pin" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-black mb-3">SmartPlanner</h2>
            <p class="text-slate-500 text-sm mb-8">Pianifica lo Smart Working. I tuoi dati e i giorni di recupero sono al sicuro sul Cloud.</p>
            
            <button id="loginBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 active:scale-95 transition-all shadow-lg">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Accedi con Google
            </button>
            <div id="loadingStatus" class="hidden mt-4 text-xs font-bold text-red-600 uppercase"></div>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <header class="sticky top-0 z-50 sticky-header text-white p-4 shadow-md">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <button id="logoutBtn" class="p-2"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                <select id="monthSelector" class="bg-blue-700 border border-blue-400 rounded-xl px-4 py-1.5 text-sm font-bold outline-none"></select>
                <div id="syncStatus" class="w-3 h-3 rounded-full bg-green-400"></div>
            </div>
        </header>
        <main class="max-w-md mx-auto px-4 mt-6 space-y-4">
            <section class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm text-center">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase font-black">Smart %</label>
                        <input type="number" id="swPercentage" class="w-full bg-slate-50 rounded-2xl py-3 text-center text-xl font-black outline-none border-2 border-transparent focus:border-blue-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase font-black">Recupero (gg)</label>
                        <input type="number" id="recoveryDays" class="w-full bg-slate-50 rounded-2xl py-3 text-center text-xl font-black outline-none border-2 border-transparent focus:border-blue-500 transition-all">
                    </div>
                </div>
            </section>
            <section class="grid grid-cols-2 gap-3 sticky top-[80px] z-40">
                <div id="cardSW" class="bg-white/90 backdrop-blur-md rounded-[1.5rem] p-4 shadow-lg border-2 border-transparent">
                    <span class="text-slate-500 text-[10px] font-bold uppercase block mb-1 text-center">Smart Target</span>
                    <div class="flex justify-center items-baseline gap-1"><span id="actualSW" class="text-3xl font-black">0</span><span class="text-slate-400 font-bold text-sm">/ <span id="targetSW">0</span></span></div>
                </div>
                <div id="cardPresenza" class="bg-white/90 backdrop-blur-md rounded-[1.5rem] p-4 shadow-lg border-2 border-transparent">
                    <span class="text-slate-500 text-[10px] font-bold uppercase block mb-1 text-center">Ufficio Target</span>
                    <div class="flex justify-center items-baseline gap-1"><span id="actualPresenza" class="text-3xl font-black">0</span><span class="text-slate-400 font-bold text-sm">/ <span id="targetPresenza">0</span></span></div>
                </div>
            </section>
            <div id="calendarList" class="space-y-2 pb-10"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
  apiKey: "AIzaSyBZ8vqYNgqhCe2Bi21CaRiOp5jiz9EEeFo",
  authDomain: "smartplannerinv.firebaseapp.com",
  databaseURL: "https://smartplannerinv-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "smartplannerinv",
  storageBucket: "smartplannerinv.firebasestorage.app",
  messagingSenderId: "845850448866",
  appId: "1:845850448866:web:bb849a171023ce57725fbb",
  measurementId: "G-5B9GCHDX7E"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let state = { currentMonth: new Date().toISOString().slice(0, 7), data: {}, config: { percentage: 60, recovery: 0 } };

        const dom = {
            authOverlay: document.getElementById('authOverlay'),
            appContent: document.getElementById('appContent'),
            loginBtn: document.getElementById('loginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            loadingStatus: document.getElementById('loadingStatus'),
            monthSelector: document.getElementById('monthSelector'),
            swPercentage: document.getElementById('swPercentage'),
            recoveryDays: document.getElementById('recoveryDays'),
            calendarList: document.getElementById('calendarList'),
            targetSW: document.getElementById('targetSW'),
            targetPresenza: document.getElementById('targetPresenza'),
            actualSW: document.getElementById('actualSW'),
            actualPresenza: document.getElementById('actualPresenza'),
            cardSW: document.getElementById('cardSW'),
            cardPresenza: document.getElementById('cardPresenza'),
            syncStatus: document.getElementById('syncStatus')
        };

        // Persistenza sessione
        setPersistence(auth, browserLocalPersistence);

        // LOGIN CON POPUP (Pi√π stabile del redirect in caso di loop)
        dom.loginBtn.onclick = async () => {
            try {
                dom.loadingStatus.classList.add('hidden');
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                dom.loadingStatus.textContent = "Errore: " + error.message;
                dom.loadingStatus.classList.remove('hidden');
            }
        };

        dom.logoutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                dom.authOverlay.classList.add('hidden');
                dom.appContent.classList.remove('hidden');
                initApp();
            } else {
                currentUser = null;
                dom.authOverlay.classList.remove('hidden');
                dom.appContent.classList.add('hidden');
            }
        });

        // --- Funzioni initApp, save, render (stesse di prima) ---
        function initApp() {
            const now = new Date();
            dom.monthSelector.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                dom.monthSelector.innerHTML += `<option value="${val}">${d.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}</option>`;
            }
            dom.monthSelector.value = state.currentMonth;
            onValue(ref(db, 'users/' + currentUser.uid), (snap) => {
                const cloud = snap.val();
                if (cloud) {
                    state.data = cloud.calendar || {};
                    state.config = cloud.settings || { percentage: 60, recovery: 0 };
                    dom.swPercentage.value = state.config.percentage;
                    dom.recoveryDays.value = state.config.recovery;
                }
                render();
            });
            dom.monthSelector.onchange = (e) => { state.currentMonth = e.target.value; render(); };
            const sync = () => {
                state.config.percentage = parseInt(dom.swPercentage.value) || 0;
                state.config.recovery = parseInt(dom.recoveryDays.value) || 0;
                save();
            };
            dom.swPercentage.oninput = sync;
            dom.recoveryDays.oninput = sync;
        }

        function save() {
            dom.syncStatus.classList.replace('bg-green-400', 'bg-amber-400');
            set(ref(db, 'users/' + currentUser.uid), { calendar: state.data, settings: state.config })
                .then(() => dom.syncStatus.classList.replace('bg-amber-400', 'bg-green-400'));
        }

        function getHolidays(y) {
            const h = [`${y}-01-01`,`${y}-01-06`,`${y}-04-25`,`${y}-05-01`,`${y}-06-02`,`${y}-08-15`,`${y}-11-01`,`${y}-12-08`,`${y}-12-25`,`${y}-12-26` ];
            const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h_b=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h_b-k)%7,m=Math.floor((a+11*h_b+22*l)/451),month=Math.floor((h_b+l-7*m+114)/31),day=((h_b+l-7*m+114)%31)+1;
            h.push(`${y}-${String(month).padStart(2,'0')}-${String(day+1).padStart(2,'0')}`);
            return h;
        }

        function render() {
            const [y, m] = state.currentMonth.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            const holidays = getHolidays(y);
            let html = '', workdays = 0, count = { presenza:0, sw:0, ferie:0, malattia:0 };
            for (let d = 1; d <= daysInMonth; d++) {
                const dObj = new Date(y, m-1, d, 12, 0, 0);
                const dStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if (dObj.getDay()!==0 && dObj.getDay()!==6 && !holidays.includes(dStr)) {
                    workdays++;
                    const val = (state.data[state.currentMonth] && state.data[state.currentMonth][d]) || 'presenza';
                    count[val]++;
                    html += `<div class="bg-white p-4 rounded-2xl flex items-center justify-between border border-slate-100 shadow-sm">
                        <div class="bg-slate-50 rounded-xl p-2 min-w-[55px] text-center">
                            <span class="block text-[10px] font-bold text-blue-600 uppercase">${dObj.toLocaleDateString('it-IT',{weekday:'short'})}</span>
                            <span class="text-xl font-black text-slate-800">${d}</span>
                        </div>
                        <select onchange="window.updateDay(${d}, this.value)" class="rounded-xl px-4 py-3 text-sm font-black outline-none shadow-sm">
                            <option value="presenza" ${val==='presenza'?'selected':''}>üè¢ Ufficio</option>
                            <option value="sw" ${val==='sw'?'selected':''}>üè† Smart</option>
                            <option value="ferie" ${val==='ferie'?'selected':''}>üå¥ Ferie</option>
                            <option value="malattia" ${val==='malattia'?'selected':''}>ü§í Malattia</option>
                        </select>
                    </div>`;
                }
            }
            dom.calendarList.innerHTML = html;
            const netti = workdays - count.ferie;
            const tSW = Math.max(0, Math.round(netti * (state.config.percentage/100)) - count.malattia);
            const tPres = Math.round(netti * (1 - state.config.percentage/100)) + state.config.recovery;
            dom.targetSW.textContent = tSW; dom.targetPresenza.textContent = tPres;
            dom.actualSW.textContent = count.sw; dom.actualPresenza.textContent = count.presenza;
            dom.cardSW.style.borderColor = count.sw > tSW ? '#ef4444' : 'transparent';
            dom.cardPresenza.style.borderColor = count.presenza < tPres ? '#f59e0b' : 'transparent';
            lucide.createIcons();
        }

        window.updateDay = (d, v) => {
            if(!state.data[state.currentMonth]) state.data[state.currentMonth] = {};
            state.data[state.currentMonth][d] = v;
            save();
        };
        lucide.createIcons();
    </script>
</body>
</html>
